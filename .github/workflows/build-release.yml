name: Build and Release

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RUST_VERSION: '1.75.0'

jobs:
  # ========================================
  # Build Server (Rust) - Linux
  # ========================================
  build-server-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build Server
        working-directory: ./server
        run: |
          cargo build --release
          strip target/release/privmsg-server

      - name: Upload Linux Server
        uses: actions/upload-artifact@v4
        with:
          name: privmsg-server-linux
          path: server/target/release/privmsg-server

  # ========================================
  # Build Server (Rust) - Windows
  # ========================================
  build-server-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build Server
        working-directory: ./server
        run: cargo build --release

      - name: Upload Windows Server
        uses: actions/upload-artifact@v4
        with:
          name: privmsg-server-windows
          path: server/target/release/privmsg-server.exe

  # ========================================
  # Build Desktop Client (Rust + iced) - Linux
  # ========================================
  build-desktop-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev libasound2-dev \
            libgtk-3-dev libxdo-dev libdbus-1-dev

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build Desktop Client
        working-directory: ./desktop
        run: |
          cargo build --release
          strip target/release/privmsg-desktop

      - name: Create Archive
        run: |
          cd desktop/target/release
          tar -czf ../../../privmsg-desktop-linux.tar.gz privmsg-desktop

      - name: Upload Linux Desktop
        uses: actions/upload-artifact@v4
        with:
          name: privmsg-desktop-linux
          path: privmsg-desktop-linux.tar.gz

  # ========================================
  # Build Desktop Client (Rust + iced) - Windows
  # ========================================
  build-desktop-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build Desktop Client
        working-directory: ./desktop
        run: cargo build --release

      - name: Create Archive
        shell: pwsh
        run: |
          Compress-Archive -Path desktop/target/release/privmsg-desktop.exe -DestinationPath privmsg-desktop-windows.zip

      - name: Upload Windows Desktop
        uses: actions/upload-artifact@v4
        with:
          name: privmsg-desktop-windows
          path: privmsg-desktop-windows.zip

  # ========================================
  # Build Android Client (Kotlin)
  # ========================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build APK
        working-directory: ./android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease --no-daemon

      - name: Find APK
        id: find_apk
        run: |
          APK_PATH=$(find android -name "*.apk" -path "*release*" | head -1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: privmsg-android
          path: ${{ steps.find_apk.outputs.apk_path }}

  # ========================================
  # Build Docker Image
  # ========================================
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/${{ github.repository }}/privmsg-server:latest
            ghcr.io/${{ github.repository }}/privmsg-server:${{ github.ref_name }}

  # ========================================
  # Create Release
  # ========================================
  release:
    needs: [build-server-linux, build-server-windows, build-desktop-linux, build-desktop-windows, build-android, build-docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir -p release

          # Server
          mv artifacts/privmsg-server-linux/privmsg-server release/privmsg-server-linux
          mv artifacts/privmsg-server-windows/privmsg-server.exe release/privmsg-server-windows.exe
          chmod +x release/privmsg-server-linux

          # Desktop Clients
          mv artifacts/privmsg-desktop-linux/privmsg-desktop-linux.tar.gz release/
          mv artifacts/privmsg-desktop-windows/privmsg-desktop-windows.zip release/

          # Android
          APK=$(find artifacts/privmsg-android -name "*.apk" | head -1)
          mv "$APK" release/privmsg-android.apk

          # Create checksums
          cd release
          sha256sum * > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*
          body: |
            ## PrivMsg ${{ github.ref_name }}

            Private E2EE Messenger - Self-hosted secure messaging.

            ### Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `privmsg-android.apk` | Android app (requires Android 7.0+) |
            | Windows | `privmsg-desktop-windows.zip` | Windows 10/11 (64-bit) |
            | Linux | `privmsg-desktop-linux.tar.gz` | Linux (64-bit, tested on Ubuntu/Arch) |
            | Server (Linux) | `privmsg-server-linux` | Server binary for Linux |
            | Server (Windows) | `privmsg-server-windows.exe` | Server binary for Windows |

            ### Docker

            ```bash
            docker pull ghcr.io/${{ github.repository }}/privmsg-server:${{ github.ref_name }}
            ```

            ### Features

            - End-to-End Encryption (X25519 + AES-256-GCM)
            - Text, voice, and video messages
            - Voice and video calls with TURN support
            - File sharing (documents, photos, videos)
            - Multi-device support
            - Self-hosted - full control over your data

            ### Quick Start

            See [Full Guide (Russian)](docs/FULL_GUIDE_RU.md) for detailed setup instructions.

            ```bash
            # One-line install on your server
            curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash
            ```
          draft: false
          prerelease: false
